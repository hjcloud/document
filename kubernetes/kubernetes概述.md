# 概述

kubernetes 是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。

## 部署演进

### 物理机部署时代

直接在物理服务器上运行应用程序，无法限制应用程序资源的使用，存在资源分配问题。运行多个应用程序时，可能存在其中一个程序占用大量资源，导致同一台机器的程序都受到影响。如果一台机器只运行一个应用程序，可能无法充分利用资源，且维护成本极高。

### 虚拟化部署时代

单个物理服务器运行多台虚拟机，应用程序运行在不同的虚拟机中，拥有各自的操作系统，能提供一定的隔离性和安全性。且更容易分配资源，管理应用程序。但虚拟机较为笨重，占了很大的额外开销，启动和销毁都较为缓慢。

### 容器部署时代

类似虚拟机，但相较于虚拟机更加轻量和宽松，容器之间共享操作系统，但有自己的文件系统、CPU、内存、进程空间等。与虚拟机运行在操作系统之上不同，容器运行在隔离的空间之中，不依赖于底层操作系统，具有强大的移植性，在各环境之间保持一致。

## 优势

* **服务发现和负载均衡**

  可以使用 DNS 名称或自己的 IP 地址来暴露容器，提供负载均衡能力。

* **存储编排**

  允许自动选择挂载存储系统，例如本地存储、公共云提供商等。

* **自动部署和回滚**

  可以自动化部署创建新容器，支持镜像回滚。

* **自动完成装箱计算**

  为 kubernetes 提供许多节点组成的集群。通过指定容器需要的 CPU 和内存(RAM)，kubernetes 自动进行资源的调度。

* **自我修复**

  自动重启失败的容器、替换容器、停止不健康容器等。

* **密钥与配置管理**

  存储和管理敏感配置信息，与容器分离。

## 架构

![Kubernetes 的组件](/images/components-of-kubernetes.svg)

一个 kubernetes 集群由一组工作机器(即节点)组成，每个集群至少有一个工作节点。

### 控制平面组件（Control Plane Components）

为集群做出全局决策，例如资源调度、检测和响应集群时间等。

控制平面可以在集群的任何节点上运行。为了简单起见，通常会在同一台机器上启动所有控制平面组件，并且不会在该计算机上运行用户容器。

#### kube-apiserver

API 服务是控制平面下的一个组件，暴露 Kubernetes API，作为控制平面的前端。

kube-apiserver 是 Kubernetes API 服务最主要的实现。在设计上支持水平扩缩容，即可以通过部署更多实例来进行水平扩缩容。可以运行 kube-apiserver 的多个实例，并且在这些实例之间平衡流量。

#### etcd

一致性高可用的键值存储，作为 Kubernetes 所有集群数据的后台存储。

#### kube-scheduler

负责监视新创建的、未指定运行节点的 Pods，并且选择一个节点来运行这些 Pods。

调度决策考虑的因素包括单个 Pod 及 Pods 集合的资源需求、软硬件和策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后期限。

#### kube-controller-manager

负责运行控制器进程。

逻辑上说，每个控制器都是一个单独的进程，但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。

控制器包括：

* 节点控制器（Node Controller）：负责在节点出现故障时进行通知和响应。
* 任务控制器（Job Controller）：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成。
* 端点控制器（Endpoints Controller）：填充端点对象（即加入 Service 和 Pod）。
* 服务账户和令牌控制器（Service Account & Token Controllers）：为新的命名空间创建默认账户和 API 访问令牌。

#### cloud-controller-manager

嵌入了特定于云平台的控制逻辑，允许将集群连接到云提供商的 API 之上，并将与该云平台交互的组件同与集群交互的组件分离开。

与 kube-controller-manager 类似，多个控制器在同一可执行文件同一进程中运行。可进行水平扩容。

控制器包括：

* 节点控制器（Node Controller）：用于在节点终止响应后检查云提供商以确定节点是否已被删除。
* 路由控制器（Route Controller）：用于在底层云基础架构中设置路由。
* 服务控制器（Service Controller）：用于创建、更新和删除云提供商负载均衡器。